# Description
This service uses machine learning models to process a face in an image in order to guess the gender, the age, the race and the emotion. This service was built and tested with python 3.9, therefore we recommend to use the docker version instead of running it natively.

# How to run
## Environment variables
Using both docker or your local python3, the engine will use the following environment variables if defined.

*General variables*

- APP_HOST: address on which the API will listen, default is 127.0.0.1
- APP_PORT: port the API will listen on, default is 8080
- APP_LOG: log level, default is info
- APP_ENGINE: the url to the engine, if provided, the service will announce itself to the engine periodically
- APP_SERVICE: the url of the service itself, needed to announce correct routes to the engine
- APP_NOTIFY_CRON: the frequency in second of the heartbeat announce to the engine, default is 30

## Run natively
### Install dependencies
Install the requirements using `pip3`

```bash
pip3 install -r requirements.txt
```

* In order to work, some packages may need a few additional libs that you can install with your distribution package manager, check console at run time.
### Run the tests
To run the tests, the following additional packages must be installed:

```bash
pip3 install pytest pytest-asyncio aiofile
```

Then, the tests can be run with:
```bash
python3 -m pytest --asyncio-mode=auto
```

### Run
Then, you can run the following command to run it in dev:

```bash
python3 main.py
```

or with custom environment variables:

```bash
APP_HOST=0.0.0.0 APP_PORT=4040 APP_LOG=info APP_... python3 main.py
```

## Run using docker
### Build docker image
The service docker image can be built using the dockerfile using the command:

```bash
docker build -t pi/face_analyzer -f dockerfile .
```

### Run
Then it can be run normally:

```bash
docker run -it --rm -p8080:8080 pi/face_analyzer
```

or with custom environment variables:

```bash
docker run -it --env APP_HOST=0.0.0.0 --env APP_PORT=4040 --env APP_LOG=info --env APP_... --rm -p8080:4040 pi/face_analyzer
```

## Use
The API documentation is automatically generated by FastAPI using the OpenAPI standard. A user friendly interface provided by Swagger is available under the `/docs` route, where the endpoints of teh service are described.

This simple service only has one route `/compute` that takes an image as input, which will be used to process the face, if any. Warning, if the image contains several people, only one will be processed.
