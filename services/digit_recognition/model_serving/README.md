# Description
This service uses a keras model to guess a digit in an image. In order to run, you need to provide a `model.h5` file that the service will load to work. This service was built and tested with python 3.9, therefore we recommend to use the docker version instead of running it natively.

The `model.yaml` file in this folder defined the path of the model to load on the S3 server. This task is done on the *prepare* stage of the CI pipeline. The model is trained to recognize digit written in light shade on dark shades (like a white digit on a black background).

# How to run
## Environment variables
Using both docker or your local python3, the engine will use the following environment variables if defined.

*General variables*

- APP_HOST: address on which the API will listen, default is 127.0.0.1
- APP_PORT: port the API will listen on, default is 8080
- APP_LOG: log level, default is info
- APP_ENGINE: the url to the engine, if provided, the service will announce itself to the engine periodically
- APP_SERVICE: the url of the service itself, needed to announce correct routes to the engine
- APP_NOTIFY_CRON: the frequency in second of the heartbeat announce to the engine, default is 30

## Run natively
### Install dependencies
Install the requirements using `pip3`

```bash
pip3 install -r requirements.txt
```

* In order to work, some packages may need a few additional libs that you can install with your distribution package manager, check console at run time.
### Run the tests
To run the tests, the following additional packages must be installed:

```bash
pip3 install pytest pytest-asyncio aiofile
```

Then, the tests can be run with:
```bash
python3 -m pytest --asyncio-mode=auto
```

### Run
Then, you can run the following command to run it in dev:

```bash
python3 main.py
```

or with custom environment variables:

```bash
APP_HOST=0.0.0.0 APP_PORT=4040 APP_LOG=info APP_... python3 main.py
```

## Run locally using Kubernetes

Refer to the [Get started](../docs/get-started.md) documentation in order to run this service locally.

## Use
The API documentation is automatically generated by FastAPI using the OpenAPI standard. A user friendly interface provided by Swagger is available under the `/docs` route, where the endpoints of teh service are described.

This simple service only has one route `/compute` that takes an image as input, which will be used to guess the number.
