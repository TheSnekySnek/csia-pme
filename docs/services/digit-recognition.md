# digit_recognition

This service uses a keras model to guess a digit in an image.

The service is built in two steps:

1. [Model creation](#model-creation) - The creation of the model from the data
2. [Model serving](#model-serving) - The serving of the built model

## Model creation

The goal of this step is to prepare the data and train a new model. All further commands are ran in the [model_creation](../../services/digit_recognition/model_creation) directory.

### Run the experiment

The model can be tweaked using the [`params.yaml`](../../services/digit_recognition/model_creation/params.yaml) file. The `numbers` parameter allows to indicate the digits the model must be able to detect.

Run a new training using the following commands.

```sh
# Export the MinIO S3 credentials (ask them to other members of the team)
export AWS_ACCESS_KEY_ID=***
export AWS_SECRET_ACCESS_KEY=***

# Pull the required data for the experiment from MinIO
dvc pull

# Reproduce the ML experiment with DVC
dvc repro
```

The DVC pipeline is described in the [`dvc.yaml`](../../services/digit_recognition/model_creation/dvc.yaml) file.

Each stage describes the dependencies and the outputs of the stage. Every time a dependency of the experiment is updated, running `dvc repro` will run the stages of the pipeline that are affected and keep the results in cache to speed up future runs.

More information on their website: [_Get Started: Data Pipelines_ - dvc.org](https://dvc.org/doc/start/data-management/data-pipelines).

### Push new data/results to MinIO

In order to push new results to MinIO, use the following commands (similar to Git). **Note**: DVC automatically adds files that are specified in the pipelines. In other words, there are no needs to explicitely add those files with `dvc add`.

```sh
# Get the data status
dvc status

# Add the required files to DVC
dvc add <the files you would add to DVC>

# Push the data to DVC
dvc push
```

## Model serving

The goal of this step is to serve the model made in the previous step. All further commands are ran in the [model_serving](../../services/digit_recognition/model_serving) directory.

### Retrieve the model

Run the following command to get the model created from the previous step.

```sh
# Copy the model from the creation directory
cp ../model_creation/mnist_model.h5 .
```

### How to run

#### Environment variables

Using both docker or your local python3, the engine will use the following environment variables if defined.

*General variables*

- APP_HOST: address on which the API will listen, default is 127.0.0.1
- APP_PORT: port the API will listen on, default is 8080
- APP_LOG: log level, default is info
- APP_ENGINE: the url to the engine, if provided, the service will announce itself to the engine periodically
- APP_SERVICE: the url of the service itself, needed to announce correct routes to the engine
- APP_NOTIFY_CRON: the frequency in second of the heartbeat announce to the engine, default is 30

## Run natively

### Install dependencies

Install the requirements using `pip3`

```bash
pip3 install -r requirements.txt
```

* In order to work, some packages may need a few additional libs that you can install with your distribution package manager, check console at run time.

##### Run the tests

To run the tests, the following additional packages must be installed:

```bash
pip3 install pytest pytest-asyncio aiofile
```

Then, the tests can be run with:
```bash
python3 -m pytest --asyncio-mode=auto
```

##### Run

Then, you can run the following command to run it in dev:

```bash
python3 main.py
```

or with custom environment variables:

```bash
APP_HOST=0.0.0.0 APP_PORT=4040 APP_LOG=info APP_... python3 main.py
```

#### Run locally using Kubernetes

Refer to the [Get started](../guides/getting-started.md) documentation in order to run this service locally.

#### Use

The API documentation is automatically generated by FastAPI using the OpenAPI standard. A user friendly interface provided by Swagger is available under the `/docs` route, where the endpoints of teh service are described.

This simple service only has one route `/compute` that takes an image as input, which will be used to guess the number.
