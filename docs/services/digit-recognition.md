# digit_recognition

## Model creation

### Description
The goal of this project is to trigger the pipeline to create the dataset we want to train the new model and to provide it for the other service through the S3 server. To trigger the pipeline, simply edit the `numbers.dat` file with the list of the numbers which the model should recognize.

### Use Case
1. Edit the `numbers.dat` file with the numbers wanted -> Format
2. commit changes (the rest is done by the ci pipeline)

### Format
The file `numbers.dat` should contain the list of the numbers respecting the following syntaxe :
- Ascending order of the numbers
- Numbers between 0 and 9 included
- Numbers splitted by `,` character

### Artifacts
#### Dataset Generation
The datasets are pushed with DVC on the S3 and create the DVC files, which are kept as jobs artifacts. They let us track the dataset on the S3 remote server.

#### Model Generation
The model is pushed on the S3 with a predifined name based on the numbers it can recognize. The training generated graphs to track its performances, which are kept as artifacts. The console also output the accuracy compared to the raw testset and the name of the model pushed on the S3.

### Scripts
This scripts are automatically triggered by the gitlab-ci pipeline.

#### Automation
- `script_create_dataset` : Get digits from numbers.dat file and parse the list of numbers to pass it as arguments to `create_other_model.py`
- `script_push_model` : Get digits from numbers.dat file and specify the correct name to push the model on the S3
#### ML
- `create_default_model` : Create the pre-trained model from the complet MNIST dataset (recognize numbers from 0 to 9)
- `generate_mnist_sub_dataset` : Generate a sub dataset from the default dataset by precising which digits to keep. The test dataset will contain all the digits like the default one (to compare between different sub dataset)
- `create_other_model` : Create a pretrained model based on `train.csv` and `test.csv`
- `s3client` : Manage the connection to the remote Minio S3 server

## Model serving

### Description
This service uses a keras model to guess a digit in an image. In order to run, you need to provide a `model.h5` file that the service will load to work. This service was built and tested with python 3.9, therefore we recommend to use the docker version instead of running it natively.

The `model.yaml` file in this folder defined the path of the model to load on the S3 server. This task is done on the *prepare* stage of the CI pipeline. The model is trained to recognize digit written in light shade on dark shades (like a white digit on a black background).

### How to run
#### Environment variables
Using both docker or your local python3, the engine will use the following environment variables if defined.

*General variables*

- APP_HOST: address on which the API will listen, default is 127.0.0.1
- APP_PORT: port the API will listen on, default is 8080
- APP_LOG: log level, default is info
- APP_ENGINE: the url to the engine, if provided, the service will announce itself to the engine periodically
- APP_SERVICE: the url of the service itself, needed to announce correct routes to the engine
- APP_NOTIFY_CRON: the frequency in second of the heartbeat announce to the engine, default is 30

## Run natively
### Install dependencies
Install the requirements using `pip3`

```bash
pip3 install -r requirements.txt
```

* In order to work, some packages may need a few additional libs that you can install with your distribution package manager, check console at run time.
##### Run the tests
To run the tests, the following additional packages must be installed:

```bash
pip3 install pytest pytest-asyncio aiofile
```

Then, the tests can be run with:
```bash
python3 -m pytest --asyncio-mode=auto
```

##### Run
Then, you can run the following command to run it in dev:

```bash
python3 main.py
```

or with custom environment variables:

```bash
APP_HOST=0.0.0.0 APP_PORT=4040 APP_LOG=info APP_... python3 main.py
```

#### Run locally using Kubernetes

Refer to the [Get started](../docs/get-started.md) documentation in order to run this service locally.

#### Use
The API documentation is automatically generated by FastAPI using the OpenAPI standard. A user friendly interface provided by Swagger is available under the `/docs` route, where the endpoints of teh service are described.

This simple service only has one route `/compute` that takes an image as input, which will be used to guess the number.

