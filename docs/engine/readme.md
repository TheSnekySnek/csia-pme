# Engine

- [Code](../../engine)
- Engine URL when run locally: <http://localhost:8080/docs>
- MinIO Console URL when run locally: <http://localhost:9001>
- Engine URL when deployed on Fribourg's Kubernetes: <https://engine-csia-pme.kube.isc.heia-fr.ch/docs>
- MinIO Console URL when deployed on Fribourg's Kubernetes: <https://console-minio-csia-pme.kube.isc.heia-fr.ch/login>

## Description

This service allows to create and manage pipelines of microservices. This service was built and tested with python 3.9, therefore we recommend to use the docker version instead of running it natively.

The API documentation is automatically generated by FastAPI using the OpenAPI standard. A user friendly interface provided by Swagger is available under the `/docs` route, where the endpoints of the services are described.

## Pipelines

The `pipelines` folder contains several examples of ready to use pipelines:

- `blur-women.json`: Blur women detected in an image.
- `convertjpg.json`: Convert any image to jpg.
- `face-thumbs.json`: Generate a thumbnail of each face detected in the image.
- `faceblur.json`: Blur every face detected in an image.
- `people-description.json`: Analyzes every face in an image and returns a global description.

## How to run

### Environment variables

The engine will use the following environment variables if defined.

*General variables*

- `APP_HOST`: address on which the API will listen, default is 127.0.0.1
- `APP_PORT`: port the API will listen on, default is 8080
- `APP_LOG`: log level, default is info
- `APP_ENGINE`: the url to itself, needed to give the correct callback url to services
- `APP_EXTERNAL_URL`: the external url which the engine is accessed to, needed to build the correct url for the results
- `APP_CRON`: the frequency in seconds of the job that will check and clean old jobs and data, default if 300. Each 20 times this value, a job will clean all unreferenced objects on the storage that have a very old timestamp (10 times `APP_LIFESPAN`).
- `APP_LIFESPAN`: the lifespan in seconds of jobs and data, passed this delay, they are cleaned, default is 1800
- `APP_RETRY_CRON`: the frequency in seconds of the retry task, default is 30
- `APP_CLEAN_SERVICE_CRON`: the frequency in seconds of the job that will discard services if they don't announce themself frequently enough

*Storage specific variables*

- `REG_STORAGE_TYPE`: set which type of object storage to use, possible values are "local" or "S3", default is local
- `REG_LOCAL_DATA`: path to the folder where the objects should be stored, only applicable for a "local" storage type
- `S3_URL`: url to the S3 storage server, only applicable for a "S3" storage type
- `S3_ZONE`: zone of the S3 storage server, only applicable for a "S3" storage type
- `S3_KEY_ID`: key to connect to the S3 storage server, only applicable for a "S3" storage type
- `S3_SECRET_KEY`: secret to connect to the S3 storage server, only applicable for a "S3" storage type
- `S3_BUCKET`: name of the bucket to use on the S3 storage server, only applicable for a "S3" storage type

*Database specific variables*

- `REG_DB_TYPE`: define which type of storage to use for the data persistency, possible values are "memory" or "mongo", default is memory
- `MONGO_DB`: name of the mongo database to use, only applicable if database type is mongo
- `MONGO_URI`: uri to use to connect to the mongo server, usually `mongodb://MONGOUSER:MONGOPASSWD@HOST:PORT`, only applicable if database type is mongo

### Start the application

Generate the virtual environment and install the dependencies.

```sh
# Generate the virtual environment
python3 -m venv .venv

# Activate the virtual environment
source .venv/bin/activate

# Install the requirements
pip install --requirement requirements.txt

# Start the application
python3 main.py

# Start the application with custom environment variables values
APP_HOST=0.0.0.0 APP_PORT=4040 APP_LOG=info APP_... python3 main.py
```

### Run the tests

To run the tests, the following additional packages must be installed.

```sh
# Install required packages for testing
pip3 install pytest pytest-asyncio aiofile
```

Then, the tests can be run with the following commands.

```sh
# Run the tests
python3 -m pytest --asyncio-mode=auto
```

### Run locally using Kubernetes (with minikube) and official Docker images

Start the Engine with the following commands. This will start the Engine with the official Docker images that are hosted on GitHub.

In the [engine](../../engine) directory, start the Engine with the following commands.

```sh
# Start MinIO
kubectl apply \
    -f kubernetes/minio.pvc.yml \
    -f kubernetes/minio.config-map.yml \
    -f kubernetes/minio.stateful.yml \
    -f kubernetes/minio.service.yml

# Start Mongo
kubectl apply \
    -f kubernetes/mongo.pvc.yml \
    -f kubernetes/mongo.config-map.yml \
    -f kubernetes/mongo.stateful.yml \
    -f kubernetes/mongo.service.yml

# Start the engine
kubectl apply \
    -f kubernetes/engine.config-map.yml \
    -f kubernetes/engine.stateful.yml \
    -f kubernetes/engine.service.yml
```

Create a tunnel to access the Kubernetes cluster from the local machine. The terminal in which the tunnel is created must stay open.

```sh
# Open a tunnel to the Kubernetes cluster
minikube tunnel --bind-address 127.0.0.1
```

### Run locally using Kubernetes (with minikube) and a local Docker image

Start the Engine with the following commands. This will start the Engine with the a local Docker image for the Engine.

In the [engine](../../engine) directory, build the Docker image with the following commands.

```sh
# Access the Minikube's Docker environment
eval $(minikube docker-env)

# Build the Docker image
docker build -t ghcr.io/csia-pme/csia-pme-engine:latest .

# Exit the Minikube's Docker environment
eval $(minikube docker-env -u)

# Edit the `kubernetes/engine.stateful.yml` file to use the local image by uncommented the line `imagePullPolicy`
#
# From
#
#        # imagePullPolicy: Never
#
# To
#
#        imagePullPolicy: Never
```

In the [engine](../../engine) directory, start the Engine with the following commands.

```sh
# Start MinIO
kubectl apply \
    -f kubernetes/minio.pvc.yml \
    -f kubernetes/minio.config-map.yml \
    -f kubernetes/minio.stateful.yml \
    -f kubernetes/minio.service.yml

# Start Mongo
kubectl apply \
    -f kubernetes/mongo.pvc.yml \
    -f kubernetes/mongo.config-map.yml \
    -f kubernetes/mongo.stateful.yml \
    -f kubernetes/mongo.service.yml

# Start the engine
kubectl apply \
    -f kubernetes/engine.config-map.yml \
    -f kubernetes/engine.stateful.yml \
    -f kubernetes/engine.service.yml
```

Create a tunnel to access the Kubernetes cluster from the local machine. The terminal in which the tunnel is created must stay open.

```sh
# Open a tunnel to the Kubernetes cluster
minikube tunnel --bind-address 127.0.0.1
```

**Note**: The Engine StatefulSet (`engine.stateful.yml` file) must be deleted and recreated every time a new Docker image is created.
