# Engine

- [Code](../../engine)
- Access when deployed locally: <http://localhost:8080/docs>

## Description
This service allows to create and manage pipelines of microservices. This service was built and tested with python 3.9, therefore we recommend to use the docker version instead of running it natively.

## Pipelines
The `pipelines` folder contains several examples of ready to use pipelines:

- `blur-women.json`: Blur women detected in an image.
- `convertjpg.json`: Convert any image to jpg.
- `face-thumbs.json`: Generate a thumbnail of each face detected in the image.
- `faceblur.json`: Blur every face detected in an image.
- `people-description.json`: Analyzes every face in an image and returns a global description.

## How to run
### Environment variables
Using both docker or your local python3, the engine will use the following environment variables if defined.

*General variables*

- APP_HOST: address on which the API will listen, default is 127.0.0.1
- APP_PORT: port the API will listen on, default is 8080
- APP_LOG: log level, default is info
- APP_ENGINE: the url to itself, needed to give the correct callback url to services
- APP_EXTERNAL_URL: the external url which the engine is accessed to, needed to build the correct url for the results
- APP_CRON: the frequency in seconds of the job that will check and clean old jobs and data, default if 300. Each 20 times this value, a job will clean all unreferenced objects on the storage that have a very old timestamp (10 times APP_LIFESPAN).
- APP_LIFESPAN: the lifespan in seconds of jobs and data, passed this delay, they are cleaned, default is 1800
- APP_RETRY_CRON: the frequency in seconds of the retry task, default is 30
- APP_CLEAN_SERVICE_CRON: the frequency in seconds of the job that will discard services if they don't announce themself frequently enough

*Storage specific variables*

- REG_STORAGE_TYPE: set which type of object storage to use, possible values are "local" or "S3", default is local
- REG_LOCAL_DATA: path to the folder where the objects should be stored, only applicable for a "local" storage type
- S3_URL: url to the S3 storage server, only applicable for a "S3" storage type
- S3_ZONE: zone of the S3 storage server, only applicable for a "S3" storage type
- S3_KEY_ID: key to connect to the S3 storage server, only applicable for a "S3" storage type
- S3_SECRET_KEY: secret to connect to the S3 storage server, only applicable for a "S3" storage type
- S3_BUCKET: name of the bucket to use on the S3 storage server, only applicable for a "S3" storage type

*Data specific variables*

- REG_DB_TYPE: define which type of storage to use for the data persistency, possible values are "memory" or "mongo", default is memory
- MONGO_DB: name of the mongo database to use, only applicable if db type is mongo
- MONGO_URI: uri to use to connect to the mongo server, usually "mongodb://MONGOUSER:MONGOPASSWD@HOST:PORT", only applicable if db type is mongo

### Run natively
#### Install dependencies
Install the requirements using `pip3`

```bash
pip3 install -r requirements.txt
```

#### Run the tests
To run the tests, the following additional packages must be installed:

```bash
pip3 install pytest pytest-asyncio aiofile
```

Then, the tests can be run with:
```bash
python3 -m pytest --asyncio-mode=auto
```

#### Run
Then, you can run the following command to run it in dev:

```bash
python3 main.py
```

or with custom environment variables:

```bash
APP_HOST=0.0.0.0 APP_PORT=4040 APP_LOG=info APP_... python3 main.py
```

### Run locally using Kubernetes

Refer to the [Getting started](../guides/getting-started.md) guide in order to run this service locally.

### Use
The API documentation is automatically generated by FastAPI using the OpenAPI standard. A user friendly interface provided by Swagger is available under the `/docs` route, where the endpoints of teh service are described.
